<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>–Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞ —Ç–∞–±–ª–∏—Ü—è ‚Äî –±–∞–ª–∞–Ω—Å —Ä–µ–∞–∫—Ü—ñ—ó + –≤–µ–∫—Ç–æ—Ä–∏ (fixed layout)</title>

<style>
  :root{ --accent:#2a9df4; --pos:#1e6ed1; --neg:#e85d5d; --border:#9aa; --bg-react:#eef7ff; --bg-prod:#fff3f3; }
  *, *::before, *::after { box-sizing: border-box; }
  body{background:#f6f9fc; margin:0; padding:0; font-family:Arial, sans-serif; color:#222;}
  .chem-wrap{ max-width:1200px; width:calc(100% - 32px); margin:24px auto; background:#fff; padding:16px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.08); overflow:hidden; }
  .title{text-align:center; font-weight:700; margin-bottom:6px; font-size:20px;}
  .eq{ text-align:center; margin-bottom:12px; font-size:18px;}
  .formula-box{display:flex; gap:8px; justify-content:center; flex-wrap:wrap; align-items:center; margin-bottom:8px;}
  .formula-part{display:inline-flex; align-items:center; gap:6px; font-weight:600;}
  .controls-row{display:flex; gap:12px; align-items:center; justify-content:center; margin-bottom:12px; flex-wrap:wrap;}
  .layout{ display:grid; grid-template-columns: 1fr minmax(320px, 520px); gap:16px; align-items:start; }
  @media (max-width:1100px){ .layout{grid-template-columns:1fr;} }
  table.chem{border-collapse:collapse; width:100%;}
  table.chem caption{caption-side:top; font-weight:700; margin-bottom:8px; text-align:left;}
  table.chem th, table.chem td{border:1px solid var(--border); padding:6px; text-align:center; min-width:46px; background:#fff; vertical-align:middle;}
  table.chem th{background:#e6f0fb; font-weight:700;}
  .elem-cell{background:#fafafa; font-weight:600;}
  input.num{width:100%; border:0; text-align:center; font-size:14px; padding:4px; background:transparent;}
  input.num:focus{outline:1px solid var(--accent); background:#eef7ff;}
  .coef{width:56px; padding:6px; text-align:center; border-radius:6px; border:1px solid #d7eafb; background:#f8fbff;}
  .coef-row th{background:#f4f8ff;}
  .mol-header{display:flex; flex-direction:column; gap:6px; align-items:center; justify-content:center;}
  .mol-name{font-weight:700; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100px;}
  .mol-name.reactant{ color: var(--pos); }
  .mol-name.product{ color: var(--neg); }
  .group-reactants{ background: linear-gradient(180deg,var(--bg-react),#f7fbff); color:var(--pos); }
  .group-products{ background: linear-gradient(180deg,var(--bg-prod),#fff7f7); color:var(--neg); }
  .rp-cell{min-height:36px; min-width:64px; display:flex; align-items:center; justify-content:center; background:#fff; transition:color 0.15s, background 0.15s;}
  .rp-zero{color:#333;}
  .rp-pos{color:var(--pos); font-weight:700;}
  .rp-neg{color:var(--neg); font-weight:700;}
  .note{font-size:13px; color:#555; text-align:center; margin-top:8px;}
  .mol-fallback{opacity:0.7; font-style:italic;}
  .rp-header{ white-space:nowrap; vertical-align:middle; }
  .vector-panel{ background:#fff; border:1px solid #e2eefc; border-radius:10px; padding:8px; max-width:100%; overflow:hidden; }
  .vector-title{font-weight:700; font-size:15px; margin-bottom:8px; text-align:center;}
  .vector-svg{ width:100%; height:auto; display:block; background:linear-gradient(180deg,#fbfeff,#f7fbff); border-radius:8px; border:1px solid #e6f7ff; max-width:100%; overflow:hidden; }
  .axis-labels{display:flex; justify-content:space-between; align-items:center; gap:8px; padding:0 6px 6px 6px; margin-bottom:6px;}
  .axis-labels .axis-box{display:flex; flex-direction:column; align-items:center;}
  .axis-labels .axis-box .axis-title{font-weight:700; font-size:12px; color:#334;}
  .axis-labels .y-label{ font-weight:700; color:#1e6ed1; }
  .axis-labels .x-label{ font-weight:700; color:#e85d5d; }
  .vector-legend{font-size:13px; margin-top:8px; color:#444; text-align:left;}
  .method-def{font-size:13px; margin-top:10px; color:#333; background:#fbfdff; padding:8px; border-radius:6px; border:1px solid #eef6ff;}
  .method-def b{color:#112;}
  .axis-selectors{display:flex; gap:8px; justify-content:center; align-items:center; margin-bottom:8px; flex-wrap:wrap;}
  .axis-selectors label{font-size:13px; color:#333;}
  .order-selectors{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  .mapping-note-inline{font-size:14px; color:#2b4758; margin-top:8px; padding:6px 8px; background:#f7fbff; border-radius:6px; border:1px solid #e1f0ff; text-align:left;}
  @media (max-width:880px){ .coef{width:48px;} table.chem th, table.chem td{font-size:13px; padding:6px;} .formula-box{font-size:15px;} }
  .svg-axis-label { font-family: Arial, sans-serif; font-size:11px; fill:#246; }
  .svg-tick { stroke:#79a9d9; stroke-width:1; }
  .legend-inline{display:flex; gap:10px; align-items:center; font-size:13px;}
  .legend-dot{width:12px; height:12px; border-radius:6px; display:inline-block; margin-right:6px;}
  .legend-react{ background:#5da0e8; }
  .legend-prod{ background:#e85d5d; }
  .parse-panel { display:flex; gap:10px; align-items:flex-start; justify-content:center; margin-bottom:12px; flex-wrap:wrap; }
  .parse-panel textarea { width:520px; min-height:56px; padding:8px; border-radius:6px; border:1px solid #d7eafb; resize:vertical; background:#fbfeff; }
  .parse-panel button { padding:8px 10px; border-radius:6px; background:var(--accent); color:#fff; border:0; cursor:pointer; }
  .muted { opacity: 0.45; font-style:italic; }
</style>
</head>
<body>

<div class="chem-wrap">
  <div class="title">–Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞ —Ç–∞–±–ª–∏—Ü—è ‚Äî –±–∞–ª–∞–Ω—Å —Ä–µ–∞–∫—Ü—ñ—ó + –≤–µ–∫—Ç–æ—Ä–∏</div>

  <!-- INPUT PANEL: paste a balanced equation here -->
  <div class="parse-panel" aria-label="Load balanced equation">
    <div style="font-size:13px; color:#444; align-self:center;"><b>–í—Å—Ç–∞–≤—Ç–µ –∑–±–∞–ª–∞–Ω—Å–æ–≤–∞–Ω–µ —Ä—ñ–≤–Ω—è–Ω–Ω—è (–æ–¥–Ω–∞ —Ä–µ–∞–∫—Ü—ñ—è):</b></div>
    <textarea id="parsedInput" placeholder="–ù–∞–ø—Ä.: 2 H2 + O2 = 2 H2O"></textarea>
    <div style="display:flex; flex-direction:column; gap:8px;">
      <button id="loadParsedBtn" type="button">Load & Visualize</button>
      <button id="clearParsedBtn" type="button" style="background:#999;">Clear</button>
    </div>
  </div>
  <!-- /INPUT PANEL -->

  <div class="eq" aria-live="polite">
    <div class="formula-box" id="equation"></div>
    <div style="font-size:13px; color:#444;">(–†–µ–∞–∫—Ç–∞–Ω—Ç–∏ –∑–ª—ñ–≤–∞ ‚Äî –ü—Ä–æ–¥—É–∫—Ç–∏ —Å–ø—Ä–∞–≤–∞)</div>
  </div>

  <div class="controls-row">
    <div style="font-size:13px; color:#444;">–û–±–µ—Ä—ñ—Ç—å –æ—Å—ñ –¥–ª—è –≤–µ–∫—Ç–æ—Ä—ñ–≤ (X, Y):</div>
    <div class="axis-selectors" id="axisSelectors"></div>

    <div class="order-selectors" id="orderSelectors" style="margin-left:8px;">
      <label style="font-size:13px;color:#333;">–ü–æ—Ä—è–¥–æ–∫ R:</label>
      <select id="orderR" style="padding:4px;font-size:13px;">
        <option value="auto">auto (‚Üë by size)</option>
        <option value="asc">asc (by size)</option>
        <option value="desc">desc (by size)</option>
        <option value="none">none (as is)</option>
      </select>
      <label style="font-size:13px;color:#333;">–ü–æ—Ä—è–¥–æ–∫ P:</label>
      <select id="orderP" style="padding:4px;font-size:13px;">
        <option value="auto">auto (‚Üì by size)</option>
        <option value="asc">asc (by size)</option>
        <option value="desc">desc (by size)</option>
        <option value="none">none (as is)</option>
      </select>
    </div>
  </div>

  <div class="layout">
    <div>
      <table class="chem" id="mainTable" aria-label="–¢–∞–±–ª–∏—Ü—è –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ —ñ –º–æ–ª–µ–∫—É–ª">
        <caption>–¢–∞–±–ª–∏—Ü—è –∞—Ç–æ–º–Ω–∏—Ö —ñ–Ω–¥–µ–∫—Å—ñ–≤ (—Ä–µ–∞–∫—Ç–∞–Ω—Ç–∏ ‚Äî –ª—ñ–≤–æ—Ä—É—á, –ø—Ä–æ–¥—É–∫—Ç–∏ ‚Äî –ø—Ä–∞–≤–æ—Ä—É—á).</caption>
        <thead>
          <tr>
            <th scope="col" rowspan="3">–ï–ª–µ–º–µ–Ω—Ç</th>
            <th scope="col" rowspan="3">X</th>
            <th scope="col" rowspan="3">Y</th>
            <th scope="col" colspan="3" class="group-reactants">–†–µ–∞–∫—Ç–∞–Ω—Ç–∏</th>
            <th scope="col" rowspan="3" class="rp-header">R ‚àí P</th>
            <th scope="col" colspan="5" class="group-products">–ü—Ä–æ–¥—É–∫—Ç–∏</th>
          </tr>
          <tr id="moleculeNames"></tr>
          <tr id="moleculeCoefs" class="coef-row"></tr>
        </thead>
        <tbody id="elementsBody"></tbody>
      </table>

      <div class="note">–ó–º—ñ–Ω—é–π —á–∏—Å–ª–∞ —ñ–Ω–¥–µ–∫—Å—ñ–≤ –∞–±–æ –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏ ‚Äî —Ä—ñ–≤–Ω—è–Ω–Ω—è, —Ä—ñ–∑–Ω–∏—Ü—è (R ‚àí P) —Ç–∞ –≤–µ–∫—Ç–æ—Ä–∏ –æ–Ω–æ–≤–ª—é—é—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.</div>
    </div>

    <div class="vector-panel" aria-label="–ü–∞–Ω–µ–ª—å –≤–µ–∫—Ç–æ—Ä—ñ–≤">
      <div class="vector-title">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω–∞ —Å—ñ—Ç–∫–∞ ‚Äî –≤–µ–∫—Ç–æ—Ä–Ω—ñ —à–ª—è—Ö–∏ —Ä–µ–∞–∫—Ç–∞–Ω—Ç—ñ–≤ —ñ –ø—Ä–æ–¥—É–∫—Ç—ñ–≤</div>

      <div class="axis-labels">
        <div class="axis-box"><div class="axis-title">Y (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞) ‚Äî –†–µ–∞–∫—Ç–∞–Ω—Ç–∏ üîµ</div><div class="y-label" id="axisLabelY">Y:</div></div>
        <div class="axis-box"><div class="axis-title">X (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞) ‚Äî –ü—Ä–æ–¥—É–∫—Ç–∏ üî¥</div><div class="x-label" id="axisLabelX">X:</div></div>
      </div>

      <svg id="vectorSvg" class="vector-svg" viewBox="0 0 520 520" preserveAspectRatio="xMidYMid meet" role="img" aria-label="–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω–∞ —Å—ñ—Ç–∫–∞"></svg>

      <div style="margin-top:8px;">
        <div class="legend-inline"><span class="legend-dot legend-react"></span>–†–µ–∞–∫—Ç–∏–≤–Ω–∏–π —à–ª—è—Ö (R)</div>
        <div class="legend-inline" style="margin-top:4px;"><span class="legend-dot legend-prod"></span>–ü—Ä–æ–¥—É–∫—Ç–æ–≤–∏–π —à–ª—è—Ö (P)</div>
      </div>
    </div>
  </div>

  <div style="margin-top:12px;">
    <div class="vector-legend" id="vectorLegend">–¢–µ–ø–µ—Ä –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–æ–∫–∞–∑—É—î –¥–≤–∞ –∫—É–º—É–ª—è—Ç–∏–≤–Ω—ñ —à–ª—è—Ö–∏: –æ–¥–∏–Ω –¥–ª—è —Ä–µ–∞–∫—Ç–∞–Ω—Ç—ñ–≤ (—Å–∏–Ω—ñ–π, R), —ñ–Ω—à–∏–π –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç—ñ–≤ (—á–µ—Ä–≤–æ–Ω–∏–π, P).</div>

    <div class="method-def" id="methodDef" aria-live="polite" style="margin-top:10px;">
      <b>–§–æ—Ä–º–∞–ª—å–Ω—ñ –ø—Ä–∞–≤–∏–ª–∞ (–º—ñ–∫—Ä–æ‚Äë—Å–ø—Ä–∞–≤–∫–∞ –º–µ—Ç–æ–¥—É):</b>
      <ol>
        <li><b>–í–µ–∫—Ç–æ—Ä –º–æ–ª–µ–∫—É–ª–∏</b>: v = (n‚Çì, n·µß), –¥–µ n‚Çì,n·µß ‚Äî –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –∞—Ç–æ–º—ñ–≤ –≤–∏–±—Ä–∞–Ω–∏—Ö –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ —É –º–æ–ª–µ–∫—É–ª—ñ.</li>
        <li><b>–®–ª—è—Ö</b>: —à–ª—è—Ö —Å—É–º—ñ—à—ñ = –≤–ø–æ—Ä—è–¥–∫–æ–≤–∞–Ω–∞ (–ø–æ—Å–ª—ñ–¥–æ–≤–Ω–∞) —Å—É–º–∞ –≤–µ–∫—Ç–æ—Ä—ñ–≤ –º–æ–ª–µ–∫—É–ª.</li>
        <li><b>–ü–æ—á–∞—Ç–∫–æ–≤–∞ —Ç–æ—á–∫–∞</b>: –æ–±–∏–¥–≤–∞ —à–ª—è—Ö–∏ –ø–æ—á–∏–Ω–∞—é—Ç—å—Å—è –∑ (0,0).</li>
        <li><b>–ë–∞–ª–∞–Ω—Å</b>: —Ä–µ–∞–∫—Ü—ñ—è –∑–±–∞–ª–∞–Ω—Å–æ–≤–∞–Ω–∞ ‚áî –≤–µ–∫—Ç–æ—Ä–Ω—ñ –ø—ñ–¥—Å—É–º–∫–∏ —Ä–µ–∞–∫—Ç–∞–Ω—Ç—ñ–≤ —ñ –ø—Ä–æ–¥—É–∫—Ç—ñ–≤ —Å–ø—ñ–≤–ø–∞–¥–∞—é—Ç—å.</li>
        <li><b>–ü—Ä–æ—î–∫—Ü—ñ—è</b>: –≤–∏–±—ñ—Ä –æ—Å–µ–π X,Y ‚Äî —Ü–µ –ø—Ä–æ—î–∫—Ü—ñ—è –±–∞–≥–∞—Ç–æ–≤–∏–º—ñ—Ä–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å—É –Ω–∞ –ø–ª–æ—â–∏–Ω—É.</li>
        <li><b>–ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏</b>: —Å—Ç–µ—Ö—ñ–æ–º–µ—Ç—Ä–∏—á–Ω—ñ –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏ ‚Äî —Ü—ñ–ª—ñ –Ω–µ–≤—ñ–¥ º—î–º–Ω—ñ —á–∏—Å–ª–∞.</li>
      </ol>
    </div>

    <div class="mapping-note-inline" id="mappingNote" aria-hidden="false" style="margin-top:8px;"></div>
  </div>

</div>

<!-- include parser and dependencies -->
<script src="chem_vars.js"></script>
<script src="chem_balancer.js"></script>
<script src="chem_parser.js"></script>

<script>
// Main visualizer script (kept simple and using the previous implementation ideas)
document.addEventListener("DOMContentLoaded", () => {
  // Exposed internal state so we can integrate parser easily
  window.__chem_visual = {};

  const elements = ["H","C","O","N","P","S","F","Na","Ca"];
  let reactants = [ {id:"h2o", label:"H2O"}, {id:"co2", label:"CO2"}, {id:"o2", label:"O2"} ];
  let products = [ {id:"h2", label:"H2"}, {id:"o3", label:"O3"}, {id:"h2co3", label:"H2CO3"}, {id:"n2", label:"N2"}, {id:"nh3", label:"NH3"} ];

  const MAX_COEF = 100;
  const MIN_AXIS_SPAN = 10;
  const VISUAL_OFFSET_PX = 2;
  const STORAGE_KEY = 'chem_balancer_state_v1';
  let defaultIndexMap = {
    h2o: {H:2,O:1}, co2: {C:1,O:2}, o2: {O:2}, h2: {H:2}, o3: {O:3}, h2co3:{H:2,C:1,O:3}, n2: {N:2}, nh3:{N:1,H:3}
  };
  const warnedMissingMol = new Set();

  // DOM refs
  const namesRow = document.getElementById("moleculeNames");
  const coefsRow = document.getElementById("moleculeCoefs");
  const body = document.getElementById("elementsBody");
  const svg = document.getElementById("vectorSvg"); svg.setAttribute('overflow','hidden');
  const svgSize = 520; const padding = 34; const mappingNoteEl = document.getElementById('mappingNote');

  // helpers
  function q(selector){ return document.querySelector(selector); }
  function qAll(selector){ return Array.from(document.querySelectorAll(selector)); }

  function makeMolNameCell(mol, side){
    const th = document.createElement("th"); th.setAttribute("scope","col"); th.dataset.side = side; th.dataset.mol = mol.id;
    const sideClass = side === 'reactant' ? 'reactant' : 'product';
    th.innerHTML = `<div class="mol-header"><div class="mol-name ${sideClass}" data-mol="${mol.id}" id="name_${mol.id}" title="${mol.label}">${mol.label}</div></div>`;
    return th;
  }
  function makeCoefCell(mol, side){
    const th = document.createElement("th"); th.setAttribute("scope","col"); th.dataset.side = side; th.dataset.mol = mol.id;
    th.innerHTML = `<div><input class="coef" aria-label="–ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç ${mol.label}" data-mol="${mol.id}" type="number" min="0" max="${MAX_COEF}" step="1" value="1"></div>`;
    return th;
  }

  function buildMoleculeHeader(){ namesRow.innerHTML = ""; coefsRow.innerHTML = ""; reactants.forEach(m => { namesRow.appendChild(makeMolNameCell(m,'reactant')); coefsRow.appendChild(makeCoefCell(m,'reactant')); }); products.forEach(m => { namesRow.appendChild(makeMolNameCell(m,'product')); coefsRow.appendChild(makeCoefCell(m,'product')); }); }
buildMoleculeHeader();

  function defaultIndex(mol, elem){ if(!defaultIndexMap[mol]){ if(!warnedMissingMol.has(mol)){ console.warn(`defaultIndex: –Ω–µ–º–∞—î –∑–∞–ø–∏—Å—É –¥–ª—è –º–æ–ª–µ–∫—É–ª–∏ ${mol} —É defaultIndexMap ‚Äî –ø–æ–≤–µ—Ä—Ç–∞—é 0`); warnedMissingMol.add(mol); } return 0; } return (defaultIndexMap[mol][elem]) ? defaultIndexMap[mol][elem] : 0; }

  function buildElementsTable(){ body.innerHTML = ""; elements.forEach((elem, idx) => { const tr = document.createElement("tr"); const tdElem = document.createElement("td"); tdElem.className = "elem-cell"; tdElem.textContent = elem; tr.appendChild(tdElem); const tdX = document.createElement("td"); tdX.innerHTML = `<input type="radio" name="axis-x" aria-label="–û–±—Ä–∞—Ç–∏ ${elem} —è–∫ X" value="${elem}" ${idx===0 ? "checked" : "">`; tr.appendChild(tdX); const tdY = document.createElement("td"); tdY.innerHTML = `<input type="radio" name="axis-y" aria-label="–û–±—Ä–∞—Ç–∏ ${elem} —è–∫ Y" value="${elem}" ${idx===1 ? "checked" : "">`; tr.appendChild(tdY); reactants.forEach(m => { const td = document.createElement("td"); td.innerHTML = `<input class="num cell left" data-mol="${m.id}" data-elem="${elem}" type="number" value="${defaultIndex(m.id, elem)}" min="0" step="1" aria-label="–Ü–Ω–¥–µ–∫—Å ${elem} –≤ ${m.label}">`; tr.appendChild(td); }); const rpTd = document.createElement("td"); rpTd.className = "rp-cell"; rpTd.id = `rp_${elem}`; rpTd.textContent = "0"; tr.appendChild(rpTd); products.forEach(m => { const td = document.createElement("td"); td.innerHTML = `<input class="num cell right" data-mol="${m.id}" data-elem="${elem}" type="number" value="${defaultIndex(m.id, elem)}" min="0" step="1" aria-label="–Ü–Ω–¥–µ–∫—Å ${elem} –≤ ${m.label}">`; tr.appendChild(td); }); body.appendChild(tr); }); }
buildElementsTable();

  function buildFormulaHTML(molId){ const parts = []; elements.forEach(el => { const input = document.querySelector(`.cell[data-mol="${molId}"][data-elem="${el}"]`); const val = input ? Number(input.value) || 0 : 0; if(val > 0) parts.push(el + (val > 1 ? `${val}` : "")); }); return parts.length ? parts.join("") : `<span class=\"mol-fallback\">${molId}</span>`; }

  function updateDifference(){ elements.forEach(elem => { let leftSum = 0; qAll(`.left[data-elem="${elem}"]`).forEach(input => { const molId = input.dataset.mol; const coefInput = q(`.coef[data-mol="${molId}"]`); const coef = coefInput ? Math.max(0, Math.min(MAX_COEF, Math.floor(Number(coefInput.value) || 0))) : 0; leftSum += (Number(input.value) || 0) * coef; }); let rightSum = 0; qAll(`.right[data-elem="${elem}"]`).forEach(input => { const molId = input.dataset.mol; const coefInput = q(`.coef[data-mol="${molId}"]`); const coef = coefInput ? Math.max(0, Math.min(MAX_COEF, Math.floor(Number(coefInput.value) || 0))) : 0; rightSum += (Number(input.value) || 0) * coef; }); const diff = leftSum - rightSum; const cell = document.getElementById(`rp_${elem}`); if(!cell) return; cell.textContent = diff; cell.classList.remove("rp-pos","rp-neg","rp-zero"); if(diff > 0) cell.classList.add("rp-pos"); else if(diff < 0) cell.classList.add("rp-neg"); else cell.classList.add("rp-zero"); }); }

  // very small drawVectors: only needed to show something; reuse logic from earlier but simplified
  function drawVectors(){ // compute points and draw basic grid and paths
    while (svg.firstChild) svg.removeChild(svg.firstChild);
    const axes = getSelectedAxes();
    function readCountRaw(molId, elemName){ const inp = q(`.cell[data-mol="${molId}"][data-elem="${elemName}"]`); return inp ? Math.max(0, Math.floor(Number(inp.value) || 0)) : 0; }
    const reactantsOrdered = reactants.slice(); const productsOrdered = products.slice();
    function buildCumulative(molList){ const pts = [{x:0,y:0}]; let cur = {x:0,y:0}; molList.forEach(m =>{ const coef = Math.max(0, Math.min(MAX_COEF, Math.floor(Number(q(`.coef[data-mol="${m.id}"]`)?.value || 0)))); if(coef===0) return; const vx = readCountRaw(m.id, axes.x); const vy = readCountRaw(m.id, axes.y); for(let k=0;k<coef;k++){ cur = {x: cur.x + vx, y: cur.y + vy, label: m.label}; pts.push(cur); } }); return pts; }
    const ptsR = buildCumulative(reactantsOrdered); const ptsP = buildCumulative(productsOrdered);
    // minimal drawing: show end points
    const endR = ptsR.length? ptsR[ptsR.length-1]:{x:0,y:0}; const endP = ptsP.length? ptsP[ptsP.length-1]:{x:0,y:0};
    const text = document.createElementNS('http://www.w3.org/2000/svg','text'); text.setAttribute('x',20); text.setAttribute('y',20); text.textContent = `End R: (${endR.x},${endR.y})  End P: (${endP.x},${endP.y})`; svg.appendChild(text);
  }

  function getSelectedAxes(){ const x = q('input[name="axis-x"]:checked')?.value || elements[0]; const y = q('input[name="axis-y"]:checked')?.value || elements[1] || elements[0]; if(x===y){ for(const el of elements){ if(el!==x){ const r = q(`input[name="axis-y"][value="${el}"]`); if(r) r.checked = true; return {x,y:el}; } } } return {x,y}; }

  function buildEquation(){ const leftParts=[]; reactants.forEach(m=>{ const coef = Math.max(0, Math.min(MAX_COEF, Math.floor(Number(q(`.coef[data-mol="${m.id}"]`)?.value || 0)))); const f = buildFormulaHTML(m.id); leftParts.push(coef===0?`<span class=\"muted\">${f}</span>`: (coef>1?coef:'')+f); }); const rightParts=[]; products.forEach(m=>{ const coef = Math.max(0, Math.min(MAX_COEF, Math.floor(Number(q(`.coef[data-mol="${m.id}"]`)?.value || 0)))); const f = buildFormulaHTML(m.id); rightParts.push(coef===0?`<span class=\"muted\">${f}</span>`: (coef>1?coef:'')+f); }); document.getElementById('equation').innerHTML = `<div class=\"formula-part\">${leftParts.join(' + ')}</div><div style=\"font-weight:700; padding:0 8px\"> = </div><div class=\"formula-part\">${rightParts.join(' + ')}</div>`; }

  function onChangeHandler(){ qAll('.coef').forEach(coefEl=>{ coefEl.value = Math.max(0, Math.min(MAX_COEF, Math.floor(Number(coefEl.value)||0))); }); [...reactants,...products].forEach(m=>{ const nameEl = document.getElementById(`name_${m.id}`); if(nameEl) nameEl.innerHTML = buildFormulaHTML(m.id); }); buildEquation(); updateDifference(); drawVectors(); }

  function attachInputHandlers(){ qAll('input.num').forEach(inp=>{ inp.removeEventListener('input', onChangeHandler); inp.addEventListener('input', onChangeHandler); }); qAll('.coef').forEach(inp=>{ inp.removeEventListener('input', onChangeHandler); inp.addEventListener('input', onChangeHandler); }); qAll('input[name="axis-x"]').forEach(r=> r.addEventListener('change', ()=>{ drawVectors(); })); qAll('input[name="axis-y"]').forEach(r=> r.addEventListener('change', ()=>{ drawVectors(); })); }
  attachInputHandlers();

  // Expose simple API to window so an external script can call initFromParsed
  window.__chem_visual.initFromParsed = function(txt){
    if(!txt) return; try{
      const inStr = txt.replace(/\r/g,'').trim();
      const elemsArr = Elems_List(inStr); // from chem_parser.js
      const eqParts = Equation_Split(inStr); // [inStr, Reag_Rct, Reag_Prd]
      // Build elements
      elements.length = 0; for(let i=1;i<elemsArr.length;i++) elements.push(elemsArr[i]);
      // Build reactants/products
      reactants = []; products = []; defaultIndexMap = {};
      const makeId = (s, idx)=>{ let base = String(s).replace(/[^A-Za-z0-9]/g,'_'); if(!base) base='mol'+idx; let id=base; let k=1; while(reactants.find(r=>r.id===id) || products.find(p=>p.id===id) || defaultIndexMap[id]){ id = base + '_' + (k++); } return id; };
      const reagR = eqParts[1] || []; for(let i=1;i<reagR.length;i++){ const coef = reagR[i][0]; const formulaArr = reagR[i][1]; const label = (formulaArr && formulaArr[0] && formulaArr[0][0]) ? formulaArr[0][0] : ('R'+i); const id = makeId(label, i); reactants.push({id,label}); defaultIndexMap[id] = {}; if(Array.isArray(formulaArr)){ for(let j=1;j<formulaArr.length;j++){ const el = formulaArr[j][0]; const val = Number(formulaArr[j][1])||0; if(el) defaultIndexMap[id][el]=val; } } }
      const reagP = eqParts[2] || []; for(let i=1;i<reagP.length;i++){ const coef = reagP[i][0]; const formulaArr = reagP[i][1]; const label = (formulaArr && formulaArr[0] && formulaArr[0][0]) ? formulaArr[0][0] : ('P'+i); const id = makeId(label, i+1000); products.push({id,label}); defaultIndexMap[id] = {}; if(Array.isArray(formulaArr)){ for(let j=1;j<formulaArr.length;j++){ const el = formulaArr[j][0]; const val = Number(formulaArr[j][1])||0; if(el) defaultIndexMap[id][el]=val; } } }
      // rebuild DOM
      buildMoleculeHeader(); buildElementsTable(); attachInputHandlers();
      // set coefficients if present
      const setCoef = (list, srcArr)=>{ for(let k=0;k<list.length;k++){ const m = list[k]; const src = srcArr[k+1]; const coefVal = (src && typeof src[0] !== 'undefined')? Number(src[0]) : 1; const inp = document.querySelector(`.coef[data-mol="${m.id}"]`); if(inp) inp.value = Math.max(0, Math.min(MAX_COEF, Math.floor(coefVal||0))); } };
      setCoef(reactants, reagR); setCoef(products, reagP);
      // populate element indices from defaultIndexMap
      Object.keys(defaultIndexMap).forEach(molId=>{ Object.keys(defaultIndexMap[molId]).forEach(el=>{ const inp = document.querySelector(`.cell[data-mol="${molId}"][data-elem="${el}"]`); if(inp) inp.value = defaultIndexMap[molId][el]; }); });
      onChangeHandler();
    }catch(e){ console.error('initFromParsed error', e); alert('–ü–æ–º–∏–ª–∫–∞ Equation_Split: '+(e.message||e)); }
  };

  // wire load and clear buttons to call exposed API
  document.getElementById('loadParsedBtn').addEventListener('click', ()=>{ const txt = document.getElementById('parsedInput').value.trim(); if(!txt){ alert('–í–≤–µ–¥—ñ—Ç—å —Ä—ñ–≤–Ω—è–Ω–Ω—è'); return; } window.__chem_visual.initFromParsed(txt); });
  document.getElementById('clearParsedBtn').addEventListener('click', ()=>{ document.getElementById('parsedInput').value = ''; });

  // expose for debugging
  window.__chem_visual._internal = { elements, reactants, products, defaultIndexMap };

});
</script>
</body>
</html>